# 4.2 Gestion des titres, paragraphes, liens : Sémantique et optimisation

## Les piliers de la structure documentaire

### Au-delà de la simple conversion : L'optimisation sémantique

La conversion HTML→MML ne se limite pas à un mapping mécanique. Elle implique une **compréhension profonde** de la structure documentaire et une optimisation pour la transmission. Examinons les éléments fondamentaux : titres, paragraphes et liens.

## Gestion avancée des titres

### Hiérarchie logique vs hiérarchie visuelle

#### Le piège de la hiérarchie HTML

Le HTML permet des aberrations hiérarchiques :

```html
<h1>Titre principal</h1>
<div>Contenu</div>
<h3>Sous-titre</h3>  <!-- Saut invalide H1→H3 -->
<h2>Autre titre</h2>  <!-- Niveau incorrect -->
```

Cette structure est valide en HTML mais **sémantiquement incorrecte**.

#### Normalisation MML automatique

Notre convertisseur applique une **normalisation hiérarchique** :

```html
<!-- Source HTML problématique -->
<h1>Chapitre 1</h1>
<p>Introduction</p>
<h3>Section 1.1</h3>
<p>Contenu</p>
<h2>Chapitre 2</h2>
```

```mml
#H1 Chapitre 1
#P Introduction
#H2 Section 1.1  // Correction automatique H3→H2
#P Contenu
#H1 Chapitre 2  // Préservation du niveau principal
```

**Règles de normalisation** :
1. **Pas de saut de niveau** : H1→H3 devient H1→H2
2. **Continuité logique** : Correction des inversions
3. **Contexte préservé** : L'importance relative est maintenue

### Titres imbriqués et contextuels

#### Gestion des sections profondes

```html
<section>
    <h1>Chapitre</h1>
    <section>
        <h1>Section</h1>  <!-- H1 imbriqué ! -->
        <section>
            <h2>Sous-section</h2>
        </section>
    </section>
</section>
```

**Approche naïve** : Conversion directe (problématique)

```mml
#SECTION
  #H1 Chapitre
  #SECTION
    #H1 Section  // Deux H1 dans le même document !
    #SECTION
      #H2 Sous-section
```

**Approche intelligente** : Normalisation contextuelle

```mml
#SECTION
  #H1 Chapitre
  #SECTION
    #H2 Section  // Ajustement automatique du niveau
    #SECTION
      #H3 Sous-section
```

### Métadonnées de titre

#### Extraction d'informations contextuelles

```html
<h1 id="main-title" class="important" data-priority="high">
    Titre principal
    <small>Sous-titre</small>
</h1>
```

```mml
#H1[id="main-title"][class="important"][priority="high"] Titre principal (Sous-titre)
```

**Informations préservées** :
- `id` : Identifiant unique
- Attributs sémantiques : `class`, `data-*`
- Contenu enrichi : Sous-titres intégrés

## Gestion sophistiquée des paragraphes

### Au-delà du simple conteneur

#### Fusion intelligente de paragraphes

**Problème HTML** : Paragraphes artificiellement séparés

```html
<p>Première phrase.</p>
<p>Deuxième phrase de la même idée.</p>
<p>Troisième phrase.</p>
```

**Fusion sémantique** :
```mml
#P Première phrase. Deuxième phrase de la même idée. Troisième phrase.
```

**Critères de fusion** :
- **Continuité thématique** : Phrases liées
- **Longueur raisonnable** : < 500 caractères
- **Pas de rupture sémantique** : Pas de changement de sujet

#### Segmentation logique

**Problème inverse** : Paragraphes trop longs

```html
<p>Phrase1. Phrase2. Phrase3. Phrase4. Phrase5. Phrase6. Phrase7. Phrase8. Phrase9. Phrase10.</p>
```

**Segmentation automatique** :
```mml
#P Phrase1. Phrase2. Phrase3. Phrase4. Phrase5.
#P Phrase6. Phrase7. Phrase8. Phrase9. Phrase10.
```

**Règles de segmentation** :
- **Limite de longueur** : 300-400 caractères
- **Points d'arrêt logiques** : Fin de phrase
- **Préservation du sens** : Pas de coupure au milieu d'une idée

### Gestion du contenu mixte

#### Éléments inline dans les paragraphes

```html
<p>
    Texte normal avec <strong>emphase forte</strong>,
    <em>emphase légère</em>, et <code>code inline</code>.
    <a href="/lien">Lien interne</a> et
    <img src="img.jpg" alt="Image" style="float:right">
    image intégrée.
</p>
```

```mml
#P Texte normal avec #STRONG emphase forte, #EM emphase légère, et #CODE code inline. #LINK /lien Lien interne et #IMG img.jpg Image image intégrée.
```

**Optimisations appliquées** :
1. **Suppression des espaces** autour des éléments inline
2. **Concaténation logique** du texte
3. **Préservation des attributs** essentiels
4. **Normalisation des URLs**

### Paragraphes spéciaux

#### Citations et blocs spéciaux

```html
<p>Citation : <blockquote>Texte cité</blockquote> Fin.</p>
```

```mml
#P Citation :
#BLOCKQUOTE Texte cité
#P Fin.
```

**Règle** : Les éléments de bloc dans les paragraphes sont extraits.

#### Listes dans les paragraphes

```html
<p>Étapes :
    <ol>
        <li>Première étape</li>
        <li>Deuxième étape</li>
    </ol>
</p>
```

```mml
#P Étapes :
#OL
  #LI Première étape
  #LI Deuxième étape
```

## Gestion experte des liens

### Résolution et optimisation des URLs

#### Résolution des URLs relatives

```html
<!-- Base URL : https://example.com/blog/ -->
<a href="article.html">Article local</a>
<a href="../about.html">Page parente</a>
<a href="/contact">Racine du site</a>
<a href="https://external.com">Externe</a>
```

```mml
#LINK[href="https://example.com/blog/article.html"] Article local
#LINK[href="https://example.com/about.html"] Page parente
#LINK[href="https://example.com/contact"] Racine du site
#LINK[href="https://external.com"] Externe
```

#### Déduplication intelligente

**Liens répétés** :
```html
<p>Voir <a href="/guide">le guide</a> et <a href="/guide">consulter le guide</a>.</p>
```

```mml
#P Voir #LINK /guide le guide et consulter le guide.
```

**Optimisation** : Le deuxième lien est remplacé par du texte brut (référence déjà établie).

### Classification sémantique des liens

#### Analyse du contexte

```html
<nav>
    <a href="/home">Accueil</a>
    <a href="/products">Produits</a>
</nav>

<article>
    <p>Voir <a href="/guide">notre guide</a> pour plus d'infos.</p>
</article>
```

```mml
#NAV
  #LINK[href="/home"][rel="nav"] Accueil
  #LINK[href="/products"][rel="nav"] Produits

#ARTICLE
  #P Voir #LINK /guide notre guide pour plus d'infos.
```

**Attributs ajoutés automatiquement** :
- `rel="nav"` : Liens de navigation
- `rel="external"` : Liens externes
- `rel="download"` : Téléchargements

### Gestion des ancres et références internes

#### Résolution des ancres

```html
<h2 id="section1">Section 1</h2>
<p><a href="#section1">Aller au début</a></p>
<h2 id="section2">Section 2</h2>
```

```mml
#H2[id="section1"] Section 1
#P #LINK #section1 Aller au début
#H2[id="section2"] Section 2
```

**Transformation** : `#href` → lien local, `id` préservé.

#### Validation des références

Le convertisseur vérifie la **validité des liens internes** :
- **Ancres existantes** : Vérification que `#target` existe
- **Liens cassés** : Marquage avec `[broken="true"]`
- **Correction automatique** : Suggestion de corrections

## Optimisations transversales

### Fusion sémantique

#### Élimination des conteneurs inutiles

```html
<div class="content">
    <div class="text">
        <p>Contenu</p>
    </div>
</div>
```

```mml
#P Contenu  // Conteneurs purement stylistiques supprimés
```

**Critères de suppression** :
- Classes CSS génériques (`container`, `wrapper`)
- Conteneurs sans attributs sémantiques
- Imbrication inutile

#### Consolidation des éléments similaires

**Paragraphes consécutifs courts** :
```html
<p>Mini</p>
<p>paragraphes</p>
<p>séparés</p>
```

```mml
#P Mini paragraphes séparés  // Fusionnés en un paragraphe
```

### Normalisation du contenu

#### Gestion des espaces et ponctuation

```html
<p>Texte   avec   espaces   multiples   .</p>
<p>Texte avec espaces simples.</p>
```

```mml
#P Texte avec espaces multiples.
#P Texte avec espaces simples.
```

**Règles** :
- **Espaces multiples** : Réduits à un seul
- **Ponctuation** : Normalisée (espaces avant/après)
- **Capitalisation** : Préservée

#### Décodage des entités HTML

```html
<p>Copyright &copy; 2024 &mdash; Tous droits r&eacute;serv&eacute;s</p>
```

```mml
#P Copyright © 2024 — Tous droits réservés
```

### Optimisation pour la transmission

#### Réduction de la verbosité

**Suppression des attributs redondants** :
```html
<p class="paragraph" id="p1" style="margin: 10px;">Texte</p>
```

```mml
#P[id="p1"] Texte  // style et class générique supprimés
```

#### Compression des attributs

**Groupement logique** :
```mml
#LINK[href="/page"][title="Titre"][rel="external"] Texte
```

**Optimisé pour la transmission** :
```mml
#LINK /page|Titre|external Texte  // Format compact
```

## Architecture du système de gestion

### Pipeline de traitement

```python
class ContentManager:
    def __init__(self):
        self.title_processor = TitleProcessor()
        self.paragraph_processor = ParagraphProcessor()
        self.link_processor = LinkProcessor()
        self.optimizer = ContentOptimizer()

    def process_html_content(self, html_soup, base_url=None):
        """
        Traitement complet du contenu HTML
        """
        # Phase 1 : Extraction et normalisation des titres
        titles = self.title_processor.extract_and_normalize(html_soup)

        # Phase 2 : Traitement des paragraphes
        paragraphs = self.paragraph_processor.process_paragraphs(html_soup)

        # Phase 3 : Résolution des liens
        links = self.link_processor.resolve_and_classify(html_soup, base_url)

        # Phase 4 : Optimisations transversales
        optimized_content = self.optimizer.optimize_all(titles, paragraphs, links)

        return optimized_content

class TitleProcessor:
    def extract_and_normalize(self, soup):
        """
        Extraction et normalisation des titres
        """
        headings = soup.find_all(['h1', 'h2', 'h3', 'h4', 'h5', 'h6'])

        normalized = []
        current_level = 0

        for heading in headings:
            level = int(heading.name[1])
            text = heading.get_text().strip()

            # Normalisation hiérarchique
            if level > current_level + 1:
                level = current_level + 1

            normalized.append({
                'level': level,
                'text': text,
                'attrs': self.extract_semantic_attrs(heading)
            })

            current_level = level

        return normalized
```

### Métriques de qualité

#### Cohérence structurelle
- **Hiérarchie respectée** : 100% des titres normalisés
- **Imbrication logique** : Pas de ruptures sémantiques
- **Références valides** : Tous les liens internes résolus

#### Efficacité de transmission
- **Réduction de taille** : 60-80% par rapport au HTML
- **Lisibilité préservée** : MML humainement compréhensible
- **Robustesse** : Résistance aux erreurs de transmission

## Conclusion : De la structure à l'essence

La gestion des titres, paragraphes et liens en MML transcende la simple conversion technique. Elle représente une **distillation intelligente** du contenu, préservant l'essence sémantique tout en optimisant pour la transmission.

Chaque décision - fusion de paragraphes, normalisation hiérarchique, résolution de liens - contribue à transformer le HTML verbeux en MML concis, tout en maintenant la richesse informationnelle. Cette transformation n'est pas une perte ; c'est un **raffinement**, une élévation de la structure documentaire vers sa forme la plus pure et transmissible.
