# 3.2 Syntaxe complète du MML : Précision formelle et élégance

## Anatomie d'un document MML

### Structure fondamentale

Un document MML est une **séquence linéaire d'éléments** séparés par des sauts de ligne ou des espaces sémantiques. Chaque élément suit une grammaire rigoureuse mais intuitive.

```
Document MML = Élément* EOF
Élément = Balise [Contenu] [Attributs] [Enfants]
```

### Les composants atomiques

#### 1. Les balises : Identificateurs sémantiques

**Syntaxe** : `#NOM_BALISES` (dièse suivi de lettres majuscules)

**Règles** :
- Toujours précédé du symbole `#`
- Lettres majuscules uniquement (pour la lisibilité)
- Longueur maximale : 8 caractères
- Pas d'espaces ou caractères spéciaux

**Exemples valides** :
```
#H1 #P #UL #LI #DIV #SPAN #IMG #LINK
```

**Exemples invalides** :
```
#h1 #paragraphe #liste-ordonnee #Élément #TAG_1
```

#### 2. Le contenu : Texte brut ou éléments imbriqués

**Syntaxe** : Texte suivant immédiatement la balise

**Règles** :
- Pas de guillemets nécessaires (sauf pour le texte contenant des symboles réservés)
- Encodage UTF-8 obligatoire
- Échappement automatique des caractères spéciaux dans le contexte

**Exemples** :
```
#H1 Introduction au MML
#P Ceci est un paragraphe simple.
#P "Ceci contient des guillemets"
```

#### 3. Les attributs : Métadonnées optionnelles

**Syntaxe** : `[clé=valeur]` ou `[clé="valeur avec espaces"]`

**Règles** :
- Crochets obligatoires
- Signe égal comme séparateur
- Guillemets pour les valeurs multi-mots
- Attributs multiples séparés par des espaces

**Exemples** :
```
#IMG[alt="Photo du lac"][src="/images/lake.jpg"]
#LINK[href="/contact"][title="Page de contact"]
```

#### 4. Les enfants : Imbrication hiérarchique

**Syntaxe** : Indentation ou juxtaposition explicite

**Méthode 1 - Indentation** :
```
#DIV
  #H1 Titre principal
  #P Paragraphe du contenu
```

**Méthode 2 - Juxtaposition** :
```
#DIV {#H1 Titre principal #P Paragraphe du contenu}
```

## Grammaire formelle BNF

### Définition complète

```
<document> ::= <element>*

<element> ::= <tag> [<content>] [<attributes>]* [<children>]

<tag> ::= "#" <identifier>

<identifier> ::= [A-Z][A-Z0-9_]* (longueur ≤ 8)

<content> ::= <text> | <quoted_text> | ε

<text> ::= [^#\[\]\{\}\n]* (tout sauf symboles réservés)

<quoted_text> ::= '"' [^"]* '"'

<attributes> ::= "[" <attribute> ("," <attribute>)* "]"

<attribute> ::= <key> "=" <value>

<key> ::= [a-z][a-z0-9_]*

<value> ::= <text> | <quoted_text> | <number>

<number> ::= [0-9]+ (".")? [0-9]*

<children> ::= "{" <element>* "}" | <indented_block>

<indented_block> ::= "\n" "  " <element> ("\n" "  " <element>)*
```

### Exemples de dérivation

#### Document simple
```
#H1 Mon titre
#P Mon paragraphe
```
Dérivation :
- `<document>` → `<element> <element>`
- Premier `<element>` → `#H1` + `"Mon titre"`
- Deuxième `<element>` → `#P` + `"Mon paragraphe"`

#### Document avec imbrication
```
#DIV
  #H1 Titre
  #P Texte
```
Dérivation :
- `<document>` → `<element>`
- `<element>` → `#DIV` + `<children>`
- `<children>` → `<indented_block>` → `#H1 Titre` + `#P Texte`

## Règles de syntaxe avancées

### 1. Gestion des espaces et indentation

#### Indentation sémantique
- **2 espaces** = niveau d'imbrication standard
- **4 espaces** = sous-niveau (recommandé pour la lisibilité)
- **Tabulations** = interdites (problèmes de compatibilité)

#### Espaces dans le contenu
- **Espaces multiples** = préservés dans le contenu
- **Sauts de ligne** = préservés dans les blocs de texte
- **Indentation initiale** = ignorée (normalisation automatique)

### 2. Échappement et protection

#### Caractères réservés
Certains caractères ont une signification spéciale et doivent être échappés :

| Caractère | Échappement | Contexte |
|-----------|-------------|----------|
| `#` | `\#` | Début de balise |
| `[` | `\[` | Début d'attributs |
| `]` | `\]` | Fin d'attributs |
| `{` | `\{` | Début d'enfants |
| `}` | `\}` | Fin d'enfants |
| `\` | `\\` | Caractère d'échappement |

#### Échappement automatique
Dans les environnements de conversion (HTML→MML), l'échappement est géré automatiquement :

```html
<!-- Source HTML -->
<p>Texte avec # symbole</p>
```

```mml
<!-- Résultat MML -->
#P Texte avec \# symbole
```

### 3. Commentaires et métadonnées

#### Commentaires inline
```
#P Ceci est un paragraphe  // Commentaire ignoré
```

#### Métadonnées de document
```
#META[title="Mon document"][author="John Doe"]
#H1 Titre du document
```

#### Commentaires multi-lignes
```
/*
  Commentaire multi-lignes
  Ignoré par le parser
*/
#P Contenu réel
```

## Types d'éléments spécialisés

### Éléments de structure documentaire

#### Titres hiérarchiques
```
#H1 Titre principal
#H2 Sous-titre
#H3 Sous-sous-titre
#H4 Titre de section
#H5 Titre de sous-section
#H6 Titre mineur
```

#### Sections et divisions
```
#SECTION[id="introduction"]
  #H1 Introduction
  #P Contenu de l'introduction

#DIV[class="sidebar"]
  #H2 Informations complémentaires
```

### Éléments de contenu

#### Texte formaté
```
#P Paragraphe normal
#STRONG Texte en gras
#EM Texte en italique
#CODE Bloc de code
#QUOTE Citation
```

#### Listes et énumérations
```
#UL Liste non ordonnée
  #LI Premier élément
  #LI Deuxième élément

#OL Liste ordonnée
  #LI[value="1"] Premier élément numéroté
  #LI[value="2"] Deuxième élément numéroté
```

#### Liens et références
```
#LINK[href="/page"][title="Titre de la page"] Texte du lien
#IMG[src="/image.jpg"][alt="Description"]
#ANCHOR[name="section1"] Point d'ancrage
```

### Éléments interactifs

#### Formulaires
```
#FORM[action="/submit"][method="post"]
  #INPUT[type="text"][name="username"][placeholder="Nom d'utilisateur"]
  #BUTTON[type="submit"] Envoyer
```

#### Médias riches
```
#VIDEO[src="/video.mp4"][controls="true"]
  #SOURCE[src="/video.webm"][type="video/webm"]
  #TRACK[kind="subtitles"][src="/subs.vtt"]

#AUDIO[src="/audio.mp3"][autoplay="false"]
```

## Validation et conformité

### Niveaux de conformité

#### Conformité minimale (C0)
- Syntaxe correcte
- Balises valides
- Structure cohérente

#### Conformité standard (C1)
- C0 + sémantique appropriée
- Imbrication logique
- Attributs valides

#### Conformité stricte (C2)
- C1 + optimisation maximale
- Pas de redondance
- Structure canonique

### Outil de validation

```python
class MMLValidator:
    def validate_document(self, mml_text):
        """
        Validation complète d'un document MML
        """
        ast = self.parse_to_ast(mml_text)

        errors = []
        errors.extend(self.check_syntax(ast))
        errors.extend(self.check_semantics(ast))
        errors.extend(self.check_structure(ast))

        return ValidationResult(errors, ast)

    def check_semantics(self, ast):
        """
        Vérification de la cohérence sémantique
        """
        issues = []

        # Vérifier que les titres sont dans l'ordre
        headings = self.extract_headings(ast)
        if not self.is_heading_hierarchy_valid(headings):
            issues.append("Hiérarchie de titres invalide")

        # Vérifier l'imbrication logique
        if not self.is_nesting_logical(ast):
            issues.append("Imbrication sémantiquement incorrecte")

        return issues
```

## Extensions et évolutions

### MML-Extended (MML-E)
Version avec fonctionnalités avancées :
```
#MATH Formula: E = mc²
#CHART[type="bar"][data="sales.json"]
#INTERACTIVE[type="quiz"][questions="3"]
```

### MML-Domain-Specific (MML-DS)
Spécialisations pour domaines particuliers :
- **MML-Medical** : Balises pour données médicales
- **MML-Scientific** : Équations et références
- **MML-Legal** : Clauses et amendements

### Compatibilité ascendante
Toute extension MML doit :
- Préserver la syntaxe de base
- Rester lisible humainement
- Maintenir la compatibilité avec les parsers existants

## Implémentation de référence

### Parser récursif descendant

```python
class MMLParser:
    def __init__(self, text):
        self.text = text
        self.position = 0

    def parse_document(self):
        elements = []
        while not self.is_at_end():
            element = self.parse_element()
            if element:
                elements.append(element)
        return elements

    def parse_element(self):
        if not self.match('#'):
            return None

        tag = self.parse_tag()
        content = self.parse_content()
        attributes = self.parse_attributes()
        children = self.parse_children()

        return MMLElement(tag, content, attributes, children)

    def parse_tag(self):
        tag = ""
        while self.peek().isupper() or self.peek().isdigit() or self.peek() == '_':
            tag += self.advance()
        return tag
```

## Conclusion : Syntaxe comme discipline

La syntaxe du MML n'est pas un ensemble arbitraire de règles ; c'est une **discipline qui force la clarté**. Chaque contrainte syntaxique correspond à une contrainte sémantique, chaque limitation formelle permet une liberté conceptuelle.

Comme le haïku japonais qui contraint le poète à l'essentiel, le MML contraint l'auteur à la précision sémantique. Cette contrainte n'est pas une prison ; c'est un **catalyseur de créativité**.

La syntaxe du MML est ainsi plus qu'un format : c'est une **philosophie incarnée**, une invitation à penser différemment la structure de l'information.
